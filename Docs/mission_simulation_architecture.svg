<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1540 1520" font-family="'Palatino Linotype','Palatino','Georgia',serif">
<defs>
  <!-- Arrowheads -->
  <marker id="a"  markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0 0,8 3,0 6" fill="#2d3142"/></marker>
  <marker id="aR" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0 0,8 3,0 6" fill="#a83246"/></marker>
  <marker id="aB" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0 0,8 3,0 6" fill="#1a5fa0"/></marker>
  <marker id="aG" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0 0,8 3,0 6" fill="#2a7a3a"/></marker>
  <marker id="aO" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0 0,8 3,0 6" fill="#b07618"/></marker>
  <marker id="aP" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0 0,8 3,0 6" fill="#6b3fa0"/></marker>
  <marker id="aT" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0 0,8 3,0 6" fill="#0e7c86"/></marker>
</defs>

<!-- ══════════════ BACKGROUND ══════════════ -->
<rect width="1540" height="1520" fill="#fafbfe"/>

<!-- ══════════════ TITLE BAR ══════════════ -->
<rect x="0" y="0" width="1540" height="48" fill="#2d3142"/>
<text x="28" y="31" fill="#fff" font-size="17.5" font-weight="bold" letter-spacing=".6">MISSION SIMULATION ARCHITECTURE</text>
<text x="1512" y="31" fill="#8694b0" font-size="10.5" text-anchor="end" font-style="italic">run_mission.py · Feedforward Shaping & Feedback Control Analysis</text>
<rect x="0" y="48" width="1540" height="2" fill="#3d4565"/>


<!-- ════════════════════════════════════════════════════════════════ -->
<!--  ROW 0 — INPUTS  (y = 78)                                      -->
<!-- ════════════════════════════════════════════════════════════════ -->
<text x="28" y="78" fill="#555" font-size="10.5" font-weight="bold" letter-spacing=".4" opacity=".7">INPUTS</text>

<!-- CLI -->
<rect x="28" y="90" width="174" height="52" rx="4" fill="#f4f0f8" stroke="#6b3fa0" stroke-width="1.4"/>
<text x="115" y="112" text-anchor="middle" fill="#6b3fa0" font-size="10.5" font-weight="bold">CLI Arguments</text>
<text x="115" y="127" text-anchor="middle" fill="#888" font-size="8.5" font-style="italic">--out-dir, --data-dir, flags</text>

<!-- MissionConfig -->
<rect x="240" y="86" width="318" height="60" rx="4" fill="#f4f0f8" stroke="#6b3fa0" stroke-width="1.8"/>
<text x="399" y="108" text-anchor="middle" fill="#6b3fa0" font-size="11.5" font-weight="bold">MissionConfig</text>
<text x="399" y="124" text-anchor="middle" fill="#666" font-size="8.5" font-style="italic">inertia, rotation_axis, modal_freqs_hz, modal_damping,</text>
<text x="399" y="137" text-anchor="middle" fill="#666" font-size="8.5" font-style="italic">modal_gains, slew_angle, slew_duration, controller params</text>

<!-- CLI → Config -->
<line x1="202" y1="116" x2="240" y2="116" stroke="#6b3fa0" stroke-width="1.3" marker-end="url(#aP)"/>

<!-- spacecraft_properties -->
<rect x="600" y="90" width="194" height="52" rx="4" fill="#f4f0f8" stroke="#6b3fa0" stroke-width="1.2" stroke-dasharray="5,2"/>
<text x="697" y="110" text-anchor="middle" fill="#6b3fa0" font-size="9.5" font-weight="bold">spacecraft_properties.py</text>
<text x="697" y="126" text-anchor="middle" fill="#888" font-size="8" font-style="italic">HUB_INERTIA, FLEX_MODE_MASS</text>
<line x1="600" y1="116" x2="558" y2="116" stroke="#6b3fa0" stroke-width="1" stroke-dasharray="4,2" marker-end="url(#aP)"/>

<!-- Basilisk NPZ Data -->
<rect x="840" y="86" width="240" height="60" rx="4" fill="#e6f5f0" stroke="#2a7a3a" stroke-width="1.4"/>
<text x="960" y="106" text-anchor="middle" fill="#2a7a3a" font-size="10.5" font-weight="bold">Basilisk Simulation Data</text>
<text x="960" y="122" text-anchor="middle" fill="#666" font-size="8.5" font-style="italic">vizard_demo_{method}_{ctrl}.npz</text>
<text x="960" y="135" text-anchor="middle" fill="#888" font-size="8" font-style="italic">σ, ω, torques, mode1/2, pointing</text>

<!-- Trajectory Files -->
<rect x="1120" y="90" width="200" height="52" rx="4" fill="#e6f5f0" stroke="#2a7a3a" stroke-width="1.2" stroke-dasharray="5,2"/>
<text x="1220" y="110" text-anchor="middle" fill="#2a7a3a" font-size="9.5" font-weight="bold">Trajectory File (.npz)</text>
<text x="1220" y="126" text-anchor="middle" fill="#888" font-size="8" font-style="italic">4th-order θ(t), ω(t), α(t)</text>

<!-- run_vizard_demo link -->
<rect x="1360" y="90" width="152" height="52" rx="4" fill="#f4f4f4" stroke="#999" stroke-width="1" stroke-dasharray="5,2"/>
<text x="1436" y="110" text-anchor="middle" fill="#777" font-size="9" font-weight="bold">run_vizard_demo.py</text>
<text x="1436" y="125" text-anchor="middle" fill="#999" font-size="8" font-style="italic">generates NPZ data</text>
<line x1="1360" y1="116" x2="1080" y2="116" stroke="#999" stroke-width=".8" stroke-dasharray="4,2" marker-end="url(#a)"/>


<!-- ════════════════════════════════════════════════════════════════ -->
<!--  ROW 1 — ORCHESTRATOR  (y = 178)                               -->
<!-- ════════════════════════════════════════════════════════════════ -->
<text x="28" y="178" fill="#555" font-size="10.5" font-weight="bold" letter-spacing=".4" opacity=".7">ORCHESTRATOR</text>

<rect x="28" y="190" width="1484" height="60" rx="5" fill="#2d3142" opacity=".04"/>
<rect x="430" y="194" width="680" height="52" rx="5" fill="#fff" stroke="#2d3142" stroke-width="2"/>
<text x="770" y="217" text-anchor="middle" fill="#2d3142" font-size="14" font-weight="bold">run_mission_simulation( )</text>
<text x="770" y="237" text-anchor="middle" fill="#666" font-size="9.5" font-style="italic">Orchestrates all analyses, data collection, CSV export, and plot generation</text>

<!-- Config → Orchestrator -->
<line x1="399" y1="146" x2="399" y2="172" stroke="#6b3fa0" stroke-width="1.3"/>
<line x1="399" y1="172" x2="770" y2="172" stroke="#6b3fa0" stroke-width="1.3"/>
<line x1="770" y1="172" x2="770" y2="194" stroke="#6b3fa0" stroke-width="1.3" marker-end="url(#aP)"/>
<text x="580" y="168" text-anchor="middle" fill="#6b3fa0" font-size="8.5" font-style="italic">config</text>


<!-- ════════════════════════════════════════════════════════════════ -->
<!--  ROW 2 — THREE ANALYSIS PIPELINES  (y = 290)                   -->
<!-- ════════════════════════════════════════════════════════════════ -->
<text x="28" y="290" fill="#555" font-size="10.5" font-weight="bold" letter-spacing=".4" opacity=".7">ANALYSIS PIPELINES</text>

<!-- Vertical connectors from orchestrator to three pipelines -->
<line x1="770" y1="246" x2="770" y2="270" stroke="#2d3142" stroke-width="1.5"/>
<!-- Branch left -->
<line x1="280" y1="270" x2="1270" y2="270" stroke="#2d3142" stroke-width="1.5"/>
<line x1="280" y1="270" x2="280" y2="304" stroke="#2d3142" stroke-width="1.5" marker-end="url(#a)"/>
<line x1="770" y1="270" x2="770" y2="304" stroke="#2d3142" stroke-width="1.5" marker-end="url(#a)"/>
<line x1="1270" y1="270" x2="1270" y2="304" stroke="#2d3142" stroke-width="1.5" marker-end="url(#a)"/>

<!-- ─────── PIPELINE A: Feedforward Comparison ─────── -->
<g>
  <rect x="48" y="304" width="464" height="264" rx="5" fill="#fdf3f4" stroke="#a83246" stroke-width="1.5"/>
  <rect x="48" y="304" width="464" height="28" rx="5" fill="#a83246"/>
  <rect x="48" y="320" width="464" height="12" fill="#a83246"/>
  <text x="280" y="323" text-anchor="middle" fill="#fff" font-size="11" font-weight="bold">❶  Feedforward Comparison</text>

  <!-- Method loop -->
  <rect x="68" y="348" width="424" height="24" rx="3" fill="#a83246" opacity=".08"/>
  <text x="280" y="365" text-anchor="middle" fill="#a83246" font-size="9.5" font-weight="bold">for method in [unshaped (bang-bang), fourth-order (shaped)]:</text>

  <!-- A1: Torque Profile -->
  <rect x="68" y="384" width="200" height="48" rx="3" fill="#fff" stroke="#a83246" stroke-width="1.2"/>
  <text x="168" y="404" text-anchor="middle" fill="#a83246" font-size="10" font-weight="bold">Torque Profile</text>
  <text x="168" y="420" text-anchor="middle" fill="#777" font-size="8" font-style="italic">_compute_torque_profile()</text>

  <!-- A2: Modal Simulation -->
  <rect x="292" y="384" width="200" height="48" rx="3" fill="#fff" stroke="#a83246" stroke-width="1.2"/>
  <text x="392" y="404" text-anchor="middle" fill="#a83246" font-size="10" font-weight="bold">Modal Simulation</text>
  <text x="392" y="420" text-anchor="middle" fill="#777" font-size="8" font-style="italic">_simulate_modal_response()</text>

  <!-- A1 → A2 -->
  <line x1="268" y1="408" x2="292" y2="408" stroke="#a83246" stroke-width="1.2" marker-end="url(#aR)"/>
  <text x="280" y="402" text-anchor="middle" fill="#a83246" font-size="7.5" font-style="italic">τ(t)</text>

  <!-- A-sub: state-space detail -->
  <rect x="68" y="444" width="424" height="38" rx="3" fill="#fff" stroke="#a83246" stroke-width=".8" stroke-dasharray="4,2"/>
  <text x="280" y="460" text-anchor="middle" fill="#666" font-size="8.5" font-style="italic">Coupled rigid-flex state-space:  M·q̈ + D·q̇ + K·q = B·τ</text>
  <text x="280" y="474" text-anchor="middle" fill="#888" font-size="8" font-style="italic">Output: mode1(t), mode2(t) displacements → combined + high-pass filter</text>

  <!-- A3: Metrics -->
  <rect x="128" y="494" width="304" height="44" rx="3" fill="#fff" stroke="#a83246" stroke-width="1.2"/>
  <text x="280" y="513" text-anchor="middle" fill="#a83246" font-size="10" font-weight="bold">Feedforward Metrics</text>
  <text x="280" y="528" text-anchor="middle" fill="#777" font-size="8" font-style="italic">RMS/peak torque, RMS/peak residual vibration, PSD</text>

  <!-- Connection down -->
  <line x1="280" y1="482" x2="280" y2="494" stroke="#a83246" stroke-width="1" marker-end="url(#aR)"/>
</g>


<!-- ─────── PIPELINE B: Control Analysis ─────── -->
<g>
  <rect x="538" y="304" width="464" height="264" rx="5" fill="#edf3fb" stroke="#1a5fa0" stroke-width="1.5"/>
  <rect x="538" y="304" width="464" height="28" rx="5" fill="#1a5fa0"/>
  <rect x="538" y="320" width="464" height="12" fill="#1a5fa0"/>
  <text x="770" y="323" text-anchor="middle" fill="#fff" font-size="11" font-weight="bold">❷  Control System Analysis</text>

  <!-- B1: Plant Model -->
  <rect x="558" y="348" width="200" height="48" rx="3" fill="#fff" stroke="#1a5fa0" stroke-width="1.2"/>
  <text x="658" y="368" text-anchor="middle" fill="#1a5fa0" font-size="10" font-weight="bold">Flexible Plant</text>
  <text x="658" y="383" text-anchor="middle" fill="#777" font-size="8" font-style="italic">_build_coupled_flex_state_space()</text>

  <!-- B2: Controller -->
  <rect x="782" y="348" width="200" height="48" rx="3" fill="#fff" stroke="#1a5fa0" stroke-width="1.2"/>
  <text x="882" y="368" text-anchor="middle" fill="#1a5fa0" font-size="10" font-weight="bold">Controller Design</text>
  <text x="882" y="383" text-anchor="middle" fill="#777" font-size="8" font-style="italic">Standard PD:  C = K + 4Ps</text>

  <!-- B1 → Merge, B2 → Merge -->
  <line x1="658" y1="396" x2="658" y2="412" stroke="#1a5fa0" stroke-width="1"/>
  <line x1="882" y1="396" x2="882" y2="412" stroke="#1a5fa0" stroke-width="1"/>
  <line x1="658" y1="412" x2="882" y2="412" stroke="#1a5fa0" stroke-width="1"/>
  <line x1="770" y1="412" x2="770" y2="422" stroke="#1a5fa0" stroke-width="1" marker-end="url(#aB)"/>

  <!-- B3: Open-Loop / Margins -->
  <rect x="608" y="422" width="324" height="48" rx="3" fill="#fff" stroke="#1a5fa0" stroke-width="1.2"/>
  <text x="770" y="442" text-anchor="middle" fill="#1a5fa0" font-size="10" font-weight="bold">Frequency-Domain Analysis</text>
  <text x="770" y="457" text-anchor="middle" fill="#777" font-size="8" font-style="italic">L(jω) = G(jω)·C(jω)  →  S, T, margins, modal excitation</text>

  <!-- B-sub: detail -->
  <rect x="558" y="482" width="424" height="38" rx="3" fill="#fff" stroke="#1a5fa0" stroke-width=".8" stroke-dasharray="4,2"/>
  <text x="770" y="498" text-anchor="middle" fill="#666" font-size="8.5" font-style="italic">Rigid-body loop + Flexible sigma-loop (body + camera outputs)</text>
  <text x="770" y="512" text-anchor="middle" fill="#888" font-size="8" font-style="italic">Gain margin, phase margin, Nyquist, disturbance/noise transfer functions</text>

  <!-- B4: Metrics -->
  <rect x="618" y="530" width="304" height="30" rx="3" fill="#fff" stroke="#1a5fa0" stroke-width="1.2"/>
  <text x="770" y="550" text-anchor="middle" fill="#1a5fa0" font-size="9.5" font-weight="bold">Stability Margins & Transfer Functions</text>

  <!-- Connection -->
  <line x1="770" y1="470" x2="770" y2="482" stroke="#1a5fa0" stroke-width="1" marker-end="url(#aB)"/>
  <line x1="770" y1="520" x2="770" y2="530" stroke="#1a5fa0" stroke-width="1" marker-end="url(#aB)"/>
</g>


<!-- ─────── PIPELINE C: Pointing Summary ─────── -->
<g>
  <rect x="1028" y="304" width="484" height="264" rx="5" fill="#e6f5f0" stroke="#2a7a3a" stroke-width="1.5"/>
  <rect x="1028" y="304" width="484" height="28" rx="5" fill="#2a7a3a"/>
  <rect x="1028" y="320" width="484" height="12" fill="#2a7a3a"/>
  <text x="1270" y="323" text-anchor="middle" fill="#fff" font-size="11" font-weight="bold">❸  Pointing Summary</text>

  <!-- Method+Controller loop -->
  <rect x="1048" y="348" width="444" height="24" rx="3" fill="#2a7a3a" opacity=".08"/>
  <text x="1270" y="365" text-anchor="middle" fill="#2a7a3a" font-size="9.5" font-weight="bold">for method × controller in [unshaped, fourth] × [standard_pd]:</text>

  <!-- C1: Load NPZ -->
  <rect x="1048" y="384" width="210" height="48" rx="3" fill="#fff" stroke="#2a7a3a" stroke-width="1.2"/>
  <text x="1153" y="404" text-anchor="middle" fill="#2a7a3a" font-size="10" font-weight="bold">Load NPZ Data</text>
  <text x="1153" y="420" text-anchor="middle" fill="#777" font-size="8" font-style="italic">_load_pointing_npz()</text>

  <!-- C2: Validate -->
  <rect x="1282" y="384" width="210" height="48" rx="3" fill="#fff" stroke="#2a7a3a" stroke-width="1.2"/>
  <text x="1387" y="404" text-anchor="middle" fill="#2a7a3a" font-size="10" font-weight="bold">Validate Config</text>
  <text x="1387" y="420" text-anchor="middle" fill="#777" font-size="8" font-style="italic">_npz_matches_config()</text>

  <line x1="1258" y1="408" x2="1282" y2="408" stroke="#2a7a3a" stroke-width="1.2" marker-end="url(#aG)"/>

  <!-- C-sub: error computation -->
  <rect x="1048" y="444" width="444" height="38" rx="3" fill="#fff" stroke="#2a7a3a" stroke-width=".8" stroke-dasharray="4,2"/>
  <text x="1270" y="460" text-anchor="middle" fill="#666" font-size="8.5" font-style="italic">Pointing error: σ_BR = σ_BN ⊖ σ_RN → 4·arctan(|σ_err|)</text>
  <text x="1270" y="474" text-anchor="middle" fill="#888" font-size="8" font-style="italic">Camera jitter: y_cam = θ_body + Σ qᵢ/L  (linear combination)</text>

  <!-- C3: Metrics -->
  <rect x="1128" y="498" width="284" height="44" rx="3" fill="#fff" stroke="#2a7a3a" stroke-width="1.2"/>
  <text x="1270" y="517" text-anchor="middle" fill="#2a7a3a" font-size="10" font-weight="bold">Pointing Metrics</text>
  <text x="1270" y="532" text-anchor="middle" fill="#777" font-size="8" font-style="italic">RMS vibration (mm), RMS pointing error (deg)</text>

  <!-- Connection down -->
  <line x1="1270" y1="482" x2="1270" y2="498" stroke="#2a7a3a" stroke-width="1" marker-end="url(#aG)"/>

  <!-- External NPZ link -->
  <line x1="960" y1="146" x2="960" y2="278" stroke="#2a7a3a" stroke-width="1.1" stroke-dasharray="5,3"/>
  <line x1="960" y1="278" x2="1153" y2="278" stroke="#2a7a3a" stroke-width="1.1" stroke-dasharray="5,3"/>
  <line x1="1153" y1="278" x2="1153" y2="304" stroke="#2a7a3a" stroke-width="1.1" stroke-dasharray="5,3" marker-end="url(#aG)"/>
</g>


<!-- ════════════════════════════════════════════════════════════════ -->
<!--  ROW 3 — DATA COLLECTION  (y = 610)                            -->
<!-- ════════════════════════════════════════════════════════════════ -->
<text x="28" y="610" fill="#555" font-size="10.5" font-weight="bold" letter-spacing=".4" opacity=".7">DATA COLLECTION</text>

<!-- Vertical connectors from orchestrator -->
<line x1="770" y1="246" x2="690" y2="246" stroke="#2d3142" stroke-width="0" opacity="0"/>
<!-- We connect from the orchestrator box bottom via a side path -->
<!-- Actually let's connect from the bottom of each pipeline to the data collectors -->

<!-- Connector bar -->
<rect x="28" y="618" width="1484" height="2" fill="#2d3142" opacity=".08"/>

<!-- D1: Feedforward Data -->
<rect x="48" y="628" width="340" height="52" rx="4" fill="#fff" stroke="#a83246" stroke-width="1.3"/>
<text x="218" y="649" text-anchor="middle" fill="#a83246" font-size="10" font-weight="bold">Feedforward Torque & Vibration Data</text>
<text x="218" y="668" text-anchor="middle" fill="#777" font-size="8.5" font-style="italic">_collect_feedforward_data() → torque_data, vibration_data</text>

<!-- D2: Feedback Data -->
<rect x="416" y="628" width="340" height="52" rx="4" fill="#fff" stroke="#b07618" stroke-width="1.3"/>
<text x="586" y="649" text-anchor="middle" fill="#b07618" font-size="10" font-weight="bold">Feedback Vibration & Torque Data</text>
<text x="586" y="668" text-anchor="middle" fill="#777" font-size="8.5" font-style="italic">_collect_feedback_data() → fb vibration per method×ctrl</text>

<!-- D3: Mission PSD -->
<rect x="784" y="628" width="320" height="52" rx="4" fill="#fff" stroke="#0e7c86" stroke-width="1.3"/>
<text x="944" y="649" text-anchor="middle" fill="#0e7c86" font-size="10" font-weight="bold">Mission Vibration PSD</text>
<text x="944" y="668" text-anchor="middle" fill="#777" font-size="8.5" font-style="italic">_build_mission_psd_data() → Welch PSD per combo</text>

<!-- D4: Pointing Data -->
<rect x="1132" y="628" width="340" height="52" rx="4" fill="#fff" stroke="#2a7a3a" stroke-width="1.3"/>
<text x="1302" y="649" text-anchor="middle" fill="#2a7a3a" font-size="10" font-weight="bold">Full Pointing Data</text>
<text x="1302" y="668" text-anchor="middle" fill="#777" font-size="8.5" font-style="italic">_load_all_pointing_data() → σ, ω, errors, modes</text>

<!-- Connectors from pipelines down to data collectors -->
<!-- Pipeline A → D1 -->
<line x1="280" y1="568" x2="280" y2="590" stroke="#a83246" stroke-width="1.2"/>
<line x1="280" y1="590" x2="218" y2="590" stroke="#a83246" stroke-width="1.2"/>
<line x1="218" y1="590" x2="218" y2="628" stroke="#a83246" stroke-width="1.2" marker-end="url(#aR)"/>

<!-- Pipeline B → Control analysis doesn't collect data the same way, it feeds directly to plots -->
<!-- But orchestrator calls _compute_control_analysis and stores ctrl_data -->
<!-- Show orchestrator → D2, D3 -->
<line x1="770" y1="246" x2="730" y2="246" stroke="#2d3142" stroke-width="0" opacity="0"/>

<!-- Pipeline C → D4 -->
<line x1="1270" y1="568" x2="1270" y2="590" stroke="#2a7a3a" stroke-width="1.2"/>
<line x1="1270" y1="590" x2="1302" y2="590" stroke="#2a7a3a" stroke-width="1.2"/>
<line x1="1302" y1="590" x2="1302" y2="628" stroke="#2a7a3a" stroke-width="1.2" marker-end="url(#aG)"/>

<!-- NPZ → D2 and D3 -->
<line x1="960" y1="146" x2="1050" y2="146" stroke="#2a7a3a" stroke-width=".8" stroke-dasharray="4,2" opacity="0"/>
<!-- Show dotted from Basilisk data to D2, D3, D4 -->
<line x1="850" y1="146" x2="850" y2="598" stroke="#2a7a3a" stroke-width=".9" stroke-dasharray="4,2" opacity=".5"/>
<line x1="850" y1="598" x2="586" y2="598" stroke="#b07618" stroke-width=".9" stroke-dasharray="4,2" opacity=".5"/>
<line x1="586" y1="598" x2="586" y2="628" stroke="#b07618" stroke-width=".9" stroke-dasharray="4,2" marker-end="url(#aO)"/>
<line x1="850" y1="598" x2="944" y2="598" stroke="#0e7c86" stroke-width=".9" stroke-dasharray="4,2" opacity=".5"/>
<line x1="944" y1="598" x2="944" y2="628" stroke="#0e7c86" stroke-width=".9" stroke-dasharray="4,2" marker-end="url(#aT)"/>

<!-- NPZ label on dotted line -->
<text x="865" y="400" fill="#2a7a3a" font-size="8" font-style="italic" opacity=".6" transform="rotate(-90,865,400)">NPZ data</text>


<!-- ════════════════════════════════════════════════════════════════ -->
<!--  ROW 4 — OUTPUT: CSV EXPORT  (y = 720)                         -->
<!-- ════════════════════════════════════════════════════════════════ -->
<text x="28" y="720" fill="#555" font-size="10.5" font-weight="bold" letter-spacing=".4" opacity=".7">CSV EXPORT</text>

<!-- Central merge bar -->
<line x1="218" y1="680" x2="218" y2="700" stroke="#a83246" stroke-width="1" opacity=".5"/>
<line x1="586" y1="680" x2="586" y2="700" stroke="#b07618" stroke-width="1" opacity=".5"/>
<line x1="944" y1="680" x2="944" y2="700" stroke="#0e7c86" stroke-width="1" opacity=".5"/>
<line x1="1302" y1="680" x2="1302" y2="700" stroke="#2a7a3a" stroke-width="1" opacity=".5"/>
<line x1="218" y1="700" x2="1302" y2="700" stroke="#2d3142" stroke-width="1.2" opacity=".3"/>
<line x1="770" y1="700" x2="770" y2="730" stroke="#2d3142" stroke-width="1.2" marker-end="url(#a)"/>

<rect x="170" y="730" width="1200" height="88" rx="5" fill="#fff9f0" stroke="#b07618" stroke-width="1.3"/>
<text x="770" y="752" text-anchor="middle" fill="#b07618" font-size="11" font-weight="bold">CSV Export Pipeline</text>

<!-- CSV files as a grid -->
<g font-size="8.5" fill="#555">
  <rect x="190" y="762" width="170" height="22" rx="2" fill="#fff" stroke="#ccc" stroke-width=".7"/>
  <text x="275" y="777" text-anchor="middle">feedforward_metrics.csv</text>

  <rect x="372" y="762" width="170" height="22" rx="2" fill="#fff" stroke="#ccc" stroke-width=".7"/>
  <text x="457" y="777" text-anchor="middle">feedforward_torque.csv</text>

  <rect x="554" y="762" width="170" height="22" rx="2" fill="#fff" stroke="#ccc" stroke-width=".7"/>
  <text x="639" y="777" text-anchor="middle">vibration_comparison.csv</text>

  <rect x="736" y="762" width="170" height="22" rx="2" fill="#fff" stroke="#ccc" stroke-width=".7"/>
  <text x="821" y="777" text-anchor="middle">pointing_error.csv</text>

  <rect x="918" y="762" width="155" height="22" rx="2" fill="#fff" stroke="#ccc" stroke-width=".7"/>
  <text x="996" y="777" text-anchor="middle">sensitivity.csv</text>

  <rect x="1085" y="762" width="135" height="22" rx="2" fill="#fff" stroke="#ccc" stroke-width=".7"/>
  <text x="1153" y="777" text-anchor="middle">nyquist.csv</text>

  <rect x="232" y="792" width="170" height="22" rx="2" fill="#fff" stroke="#ccc" stroke-width=".7"/>
  <text x="317" y="807" text-anchor="middle">mission_summary.csv</text>

  <rect x="414" y="792" width="170" height="22" rx="2" fill="#fff" stroke="#ccc" stroke-width=".7"/>
  <text x="499" y="807" text-anchor="middle">psd_comparison.csv</text>

  <rect x="596" y="792" width="170" height="22" rx="2" fill="#fff" stroke="#ccc" stroke-width=".7"/>
  <text x="681" y="807" text-anchor="middle">torque_psd_rms.csv</text>

  <rect x="778" y="792" width="190" height="22" rx="2" fill="#fff" stroke="#ccc" stroke-width=".7"/>
  <text x="873" y="807" text-anchor="middle">torque_command_metrics.csv</text>

  <rect x="980" y="792" width="180" height="22" rx="2" fill="#fff" stroke="#ccc" stroke-width=".7"/>
  <text x="1070" y="807" text-anchor="middle">feedforward_spectrum.csv</text>
</g>


<!-- ════════════════════════════════════════════════════════════════ -->
<!--  ROW 5 — OUTPUT: PLOT GENERATION  (y = 860)                    -->
<!-- ════════════════════════════════════════════════════════════════ -->
<text x="28" y="860" fill="#555" font-size="10.5" font-weight="bold" letter-spacing=".4" opacity=".7">PLOT GENERATION</text>

<!-- Merge bar from data collectors -->
<line x1="770" y1="818" x2="770" y2="870" stroke="#2d3142" stroke-width="1.2" marker-end="url(#a)"/>

<rect x="48" y="870" width="1444" height="310" rx="5" fill="#f4f6fb" stroke="#1a5fa0" stroke-width="1.3"/>
<text x="770" y="894" text-anchor="middle" fill="#1a5fa0" font-size="11.5" font-weight="bold">Visualization Pipeline — 17 Publication Plots</text>

<!-- Plot category columns -->
<!-- Col 1: Time-Domain -->
<rect x="68" y="910" width="250" height="254" rx="4" fill="#fff" stroke="#a83246" stroke-width="1"/>
<rect x="68" y="910" width="250" height="24" rx="4" fill="#a83246" opacity=".12"/>
<text x="193" y="927" text-anchor="middle" fill="#a83246" font-size="10" font-weight="bold">Time-Domain Response</text>

<g font-size="8.5" fill="#555" text-anchor="start">
  <circle cx="84" cy="948" r="3" fill="#a83246" opacity=".6"/>
  <text x="94" y="952">Vibration comparison</text>
  <text x="94" y="964" fill="#888" font-size="7.5" font-style="italic">displacement + acceleration</text>

  <circle cx="84" cy="982" r="3" fill="#a83246" opacity=".6"/>
  <text x="94" y="986">Pointing error time history</text>
  <text x="94" y="998" fill="#888" font-size="7.5" font-style="italic">MRP → angular error (deg)</text>

  <circle cx="84" cy="1016" r="3" fill="#a83246" opacity=".6"/>
  <text x="94" y="1020">Tracking response</text>
  <text x="94" y="1032" fill="#888" font-size="7.5" font-style="italic">reference vs actual attitude</text>

  <circle cx="84" cy="1050" r="3" fill="#a83246" opacity=".6"/>
  <text x="94" y="1054">Torque command time</text>
  <text x="94" y="1066" fill="#888" font-size="7.5" font-style="italic">FB torque per method×ctrl</text>
</g>

<!-- Col 2: Frequency-Domain -->
<rect x="340" y="910" width="288" height="254" rx="4" fill="#fff" stroke="#1a5fa0" stroke-width="1"/>
<rect x="340" y="910" width="288" height="24" rx="4" fill="#1a5fa0" opacity=".12"/>
<text x="484" y="927" text-anchor="middle" fill="#1a5fa0" font-size="10" font-weight="bold">Frequency-Domain Analysis</text>

<g font-size="8.5" fill="#555" text-anchor="start">
  <circle cx="356" cy="948" r="3" fill="#1a5fa0" opacity=".6"/>
  <text x="366" y="952">Sensitivity S(jω) & T(jω)</text>
  <text x="366" y="964" fill="#888" font-size="7.5" font-style="italic">rigid-body + flexible loops</text>

  <circle cx="356" cy="982" r="3" fill="#1a5fa0" opacity=".6"/>
  <text x="366" y="986">Nyquist diagram</text>
  <text x="366" y="998" fill="#888" font-size="7.5" font-style="italic">stability assessment L(jω)</text>

  <circle cx="356" cy="1016" r="3" fill="#1a5fa0" opacity=".6"/>
  <text x="366" y="1020">Modal excitation</text>
  <text x="366" y="1032" fill="#888" font-size="7.5" font-style="italic">qᵢ(jω) per mode per controller</text>

  <circle cx="356" cy="1050" r="3" fill="#1a5fa0" opacity=".6"/>
  <text x="366" y="1054">Loop components (per ctrl)</text>
  <text x="366" y="1066" fill="#888" font-size="7.5" font-style="italic">G(jω), C(jω), L(jω) Bode plots</text>

  <circle cx="356" cy="1084" r="3" fill="#1a5fa0" opacity=".6"/>
  <text x="366" y="1088">Tracking transfer function</text>
  <text x="366" y="1100" fill="#888" font-size="7.5" font-style="italic">closed-loop T(s) for each ctrl</text>
</g>

<!-- Col 3: PSD / Spectral -->
<rect x="650" y="910" width="268" height="254" rx="4" fill="#fff" stroke="#0e7c86" stroke-width="1"/>
<rect x="650" y="910" width="268" height="24" rx="4" fill="#0e7c86" opacity=".12"/>
<text x="784" y="927" text-anchor="middle" fill="#0e7c86" font-size="10" font-weight="bold">Spectral / PSD Plots</text>

<g font-size="8.5" fill="#555" text-anchor="start">
  <circle cx="666" cy="948" r="3" fill="#0e7c86" opacity=".6"/>
  <text x="676" y="952">Mission PSD comparison</text>
  <text x="676" y="964" fill="#888" font-size="7.5" font-style="italic">vibration ASD per method×ctrl</text>

  <circle cx="666" cy="982" r="3" fill="#0e7c86" opacity=".6"/>
  <text x="676" y="986">Torque command PSD</text>
  <text x="676" y="998" fill="#888" font-size="7.5" font-style="italic">FB torque spectral content</text>

  <circle cx="666" cy="1016" r="3" fill="#0e7c86" opacity=".6"/>
  <text x="676" y="1020">Torque PSD split (FF vs FB)</text>
  <text x="676" y="1032" fill="#888" font-size="7.5" font-style="italic">spectral contribution analysis</text>

  <circle cx="666" cy="1050" r="3" fill="#0e7c86" opacity=".6"/>
  <text x="676" y="1054">Torque PSD coherence</text>
  <text x="676" y="1066" fill="#888" font-size="7.5" font-style="italic">FF/FB spectral correlation</text>
</g>

<!-- Col 4: Transfer Functions / Noise -->
<rect x="940" y="910" width="268" height="254" rx="4" fill="#fff" stroke="#6b3fa0" stroke-width="1"/>
<rect x="940" y="910" width="268" height="24" rx="4" fill="#6b3fa0" opacity=".12"/>
<text x="1074" y="927" text-anchor="middle" fill="#6b3fa0" font-size="10" font-weight="bold">Transfer Function Plots</text>

<g font-size="8.5" fill="#555" text-anchor="start">
  <circle cx="956" cy="948" r="3" fill="#6b3fa0" opacity=".6"/>
  <text x="966" y="952">Disturbance → pointing</text>
  <text x="966" y="964" fill="#888" font-size="7.5" font-style="italic">d_ext rejection: G/(1+L)</text>

  <circle cx="956" cy="982" r="3" fill="#6b3fa0" opacity=".6"/>
  <text x="966" y="986">Disturbance → torque</text>
  <text x="966" y="998" fill="#888" font-size="7.5" font-style="italic">actuator effort for rejection</text>

  <circle cx="956" cy="1016" r="3" fill="#6b3fa0" opacity=".6"/>
  <text x="966" y="1020">Noise → torque</text>
  <text x="966" y="1032" fill="#888" font-size="7.5" font-style="italic">sensor noise amplification</text>

  <circle cx="956" cy="1050" r="3" fill="#6b3fa0" opacity=".6"/>
  <text x="966" y="1054">Noise → pointing</text>
  <text x="966" y="1066" fill="#888" font-size="7.5" font-style="italic">noise-induced jitter: T(jω)</text>
</g>

<!-- Output icon -->
<rect x="1230" y="910" width="242" height="254" rx="4" fill="#fff" stroke="#2d3142" stroke-width="1"/>
<rect x="1230" y="910" width="242" height="24" rx="4" fill="#2d3142" opacity=".12"/>
<text x="1351" y="927" text-anchor="middle" fill="#2d3142" font-size="10" font-weight="bold">Output Artifacts</text>

<g font-size="8.5" fill="#555" text-anchor="start">
  <rect x="1246" y="940" width="210" height="28" rx="3" fill="#f0f4ff" stroke="#1a5fa0" stroke-width=".7"/>
  <text x="1351" y="958" text-anchor="middle" fill="#1a5fa0" font-size="9">output/plots/*.png</text>

  <rect x="1246" y="978" width="210" height="28" rx="3" fill="#fff9f0" stroke="#b07618" stroke-width=".7"/>
  <text x="1351" y="996" text-anchor="middle" fill="#b07618" font-size="9">output/metrics/*.csv</text>

  <rect x="1246" y="1016" width="210" height="28" rx="3" fill="#f0fff5" stroke="#2a7a3a" stroke-width=".7"/>
  <text x="1351" y="1034" text-anchor="middle" fill="#2a7a3a" font-size="9">output/cache/*.npz</text>

  <rect x="1246" y="1064" width="210" height="38" rx="3" fill="#f8f4ff" stroke="#6b3fa0" stroke-width=".7"/>
  <text x="1351" y="1081" text-anchor="middle" fill="#6b3fa0" font-size="9" font-weight="bold">return dict:</text>
  <text x="1351" y="1095" text-anchor="middle" fill="#888" font-size="8" font-style="italic">feedforward, control, pointing, plots</text>
</g>


<!-- ════════════════════════════════════════════════════════════════ -->
<!--  ROW 6 — INTERNAL COMPONENTS DETAIL  (y = 1210)                -->
<!-- ════════════════════════════════════════════════════════════════ -->
<text x="28" y="1214" fill="#555" font-size="10.5" font-weight="bold" letter-spacing=".4" opacity=".7">KEY INTERNAL COMPONENTS</text>

<!-- State-Space detail -->
<rect x="48" y="1228" width="460" height="140" rx="4" fill="#fff" stroke="#a83246" stroke-width="1.2"/>
<rect x="48" y="1228" width="460" height="24" rx="4" fill="#a83246" opacity=".1"/>
<text x="278" y="1245" text-anchor="middle" fill="#a83246" font-size="10" font-weight="bold">Coupled Rigid-Flex State-Space Model</text>
<text x="68" y="1270" fill="#444" font-size="9.5" font-style="italic">_build_coupled_flex_state_space()</text>
<text x="68" y="1290" fill="#555" font-size="9">Mass matrix:  M = [I_hub + Σmᵢrᵢ²,  mᵢrᵢ ;  mᵢrᵢ,  mᵢ]</text>
<text x="68" y="1306" fill="#555" font-size="9">State-space:  ẋ = Ax + Bu,  y = Cx</text>
<text x="68" y="1322" fill="#555" font-size="9">States: [θ, q₁, q₂, θ̇, q̇₁, q̇₂]  (rigid + 2 flex modes)</text>
<text x="68" y="1338" fill="#555" font-size="9">Outputs: body angle σ (1/4 scale),  camera pointing,  positions</text>
<text x="68" y="1356" fill="#888" font-size="8.5" font-style="italic">Modes: 0.4 Hz (bending) + 1.3 Hz (torsion), ζ = [0.02, 0.015]</text>

<!-- Vibration signal processing -->
<rect x="540" y="1228" width="380" height="140" rx="4" fill="#fff" stroke="#0e7c86" stroke-width="1.2"/>
<rect x="540" y="1228" width="380" height="24" rx="4" fill="#0e7c86" opacity=".1"/>
<text x="730" y="1245" text-anchor="middle" fill="#0e7c86" font-size="10" font-weight="bold">Signal Processing Pipeline</text>
<text x="560" y="1270" fill="#444" font-size="9.5" font-style="italic">Vibration extraction:</text>
<text x="560" y="1290" fill="#555" font-size="9">1.  Combine modes: y = q₁ + q₂  (linear sum)</text>
<text x="560" y="1306" fill="#555" font-size="9">2.  High-pass filter (Butterworth 2nd-order)</text>
<text x="560" y="1322" fill="#555" font-size="9">3.  Linear detrend</text>
<text x="560" y="1338" fill="#444" font-size="9.5" font-style="italic">PSD computation:</text>
<text x="560" y="1354" fill="#555" font-size="9">Welch method, Hann window, 50% overlap, ~0.02 Hz resolution</text>

<!-- NPZ Validation -->
<rect x="952" y="1228" width="284" height="140" rx="4" fill="#fff" stroke="#2a7a3a" stroke-width="1.2"/>
<rect x="952" y="1228" width="284" height="24" rx="4" fill="#2a7a3a" opacity=".1"/>
<text x="1094" y="1245" text-anchor="middle" fill="#2a7a3a" font-size="10" font-weight="bold">NPZ Data Management</text>
<text x="972" y="1270" fill="#444" font-size="9.5" font-style="italic">File search:</text>
<text x="972" y="1288" fill="#555" font-size="9">data/ → cwd → script/ → output/</text>
<text x="972" y="1308" fill="#444" font-size="9.5" font-style="italic">Config validation:</text>
<text x="972" y="1326" fill="#555" font-size="9">modal freqs, damping, gains,</text>
<text x="972" y="1342" fill="#555" font-size="9">inertia, slew angle/duration</text>
<text x="972" y="1362" fill="#888" font-size="8.5" font-style="italic">Auto-generate via run_vizard_demo.py</text>

<!-- Mission Config detail -->
<rect x="1268" y="1228" width="244" height="140" rx="4" fill="#fff" stroke="#6b3fa0" stroke-width="1.2"/>
<rect x="1268" y="1228" width="244" height="24" rx="4" fill="#6b3fa0" opacity=".1"/>
<text x="1390" y="1245" text-anchor="middle" fill="#6b3fa0" font-size="10" font-weight="bold">Default Configuration</text>
<text x="1288" y="1268" fill="#555" font-size="9">Slew: 180° about ẑ, 30 s</text>
<text x="1288" y="1284" fill="#555" font-size="9">I = diag(900, 800, 600) kg·m²</text>
<text x="1288" y="1300" fill="#555" font-size="9">Modes: 0.4, 1.3 Hz</text>
<text x="1288" y="1316" fill="#555" font-size="9">Damping: ζ = 0.02, 0.015</text>
<text x="1288" y="1332" fill="#555" font-size="9">BW = f₁/2.5 = 0.16 Hz</text>
<text x="1288" y="1348" fill="#555" font-size="9">Camera lever arm: 4.0 m</text>
<text x="1288" y="1364" fill="#555" font-size="9">RW saturation: ±70 N·m</text>


<!-- ════════════════════════════════════════════════════════════════ -->
<!--  LEGEND  (top right)                                            -->
<!-- ════════════════════════════════════════════════════════════════ -->
<rect x="1310" y="58" width="220" height="84" rx="4" fill="#fff" stroke="#bcc" stroke-width=".7"/>
<text x="1322" y="75" fill="#444" font-size="9" font-weight="bold">COLOR LEGEND</text>
<line x1="1328" y1="86" x2="1352" y2="86" stroke="#a83246" stroke-width="2.5"/>
<text x="1360" y="90" fill="#555" font-size="8.5">Feedforward analysis</text>
<line x1="1328" y1="100" x2="1352" y2="100" stroke="#1a5fa0" stroke-width="2.5"/>
<text x="1360" y="104" fill="#555" font-size="8.5">Control / frequency-domain</text>
<line x1="1328" y1="114" x2="1352" y2="114" stroke="#2a7a3a" stroke-width="2.5"/>
<text x="1360" y="118" fill="#555" font-size="8.5">Basilisk data / pointing</text>
<line x1="1328" y1="128" x2="1352" y2="128" stroke="#0e7c86" stroke-width="2.5"/>
<text x="1360" y="132" fill="#555" font-size="8.5">Spectral / PSD</text>


<!-- ════════════════════════════════════════════════════════════════ -->
<!--  BOTTOM INFO BAR                                                -->
<!-- ════════════════════════════════════════════════════════════════ -->
<rect x="0" y="1390" width="1540" height="1" fill="#2d3142" opacity=".1"/>

<!-- Data flow summary at the very bottom -->
<g transform="translate(48, 1404)">
  <text x="0" y="14" fill="#2d3142" font-size="10.5" font-weight="bold">DATA FLOW SUMMARY</text>

  <!-- Arrow chain 1: Feedforward -->
  <text x="0" y="36" fill="#a83246" font-size="9.5">Feedforward:</text>
  <text x="80" y="36" fill="#555" font-size="9">Config → Torque Profile (bang-bang / 4th-order) → State-Space Simulation → Vibration → Metrics + PSD</text>

  <!-- Arrow chain 2: Control -->
  <text x="0" y="54" fill="#1a5fa0" font-size="9.5">Control:</text>
  <text x="80" y="54" fill="#555" font-size="9">Config → Plant TF (rigid + flex) + Controller TF (PD) → L(jω) → S(jω), T(jω) → Stability Margins</text>

  <!-- Arrow chain 3: Pointing -->
  <text x="0" y="72" fill="#2a7a3a" font-size="9.5">Pointing:</text>
  <text x="80" y="72" fill="#555" font-size="9">Basilisk NPZ → Validate vs Config → Extract σ, q₁, q₂ → MRP Error + Camera Jitter → RMS Metrics</text>

  <!-- Arrow chain 4: Output -->
  <text x="0" y="90" fill="#b07618" font-size="9.5">Output:</text>
  <text x="80" y="90" fill="#555" font-size="9">All Results → 11 CSV files (metrics/) + 17 PNG plots (plots/) + Summary Dict</text>
</g>

<text x="1512" y="1500" text-anchor="end" fill="#aaa" font-size="8" font-style="italic">run_mission.py · 4182 lines · Unified Mission Simulation</text>

<!-- ═══ OUTER BORDER ═══ -->
<rect x="1" y="1" width="1538" height="1512" fill="none" stroke="#2d3142" stroke-width="1" rx="2" opacity=".3"/>
</svg>